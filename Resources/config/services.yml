services:
    # Encryption services
    eh_encryption.encryption.service:
        class: EHEncryptionBundle\Service\EncryptionService
        arguments:
            - "@doctrine"
            - "@annotation_reader"
            - "@eh_encryption.cryptography_provider"
            - "@eh_encryption.key_manager"
            - "%eh_encryption.settings%"
            
    eh_encryption.cryptography_provider:
        class: EHEncryptionBundle\Crypt\CryptographyProvider
        arguments:
            - "%eh_encryption.settings%"
        
    eh_encryption.key_manager:
        class: EHEncryptionBundle\Crypt\KeyManager
        arguments:
            - "@security.token_storage"
            - "@session"
            - "@eh_encryption.cryptography_provider"
            - "@eh_encryption.key_store"
            - "@event_dispatcher"
            - "@eh_encryption.access_checker"
            - "%eh_encryption.settings%"

    eh_encryption.key_store:
        class: EHEncryptionBundle\Crypt\KeyStore
        arguments:
            - "@doctrine"
            - "@eh_encryption.cryptography_provider"
    
    # default access checker
    eh_encryption.security.access_checker.default:
        class: EHEncryptionBundle\Security\DefaultAccessChecker
        arguments:
            - "%eh_encryption.settings%"
            
    eh_encryption.security.access_checker.chained:
        class: EHEncryptionBundle\Security\ChainedAccessChecker
        arguments:
            - [ "@app.encrpytion.access_checker", "@polavis_connect.encrpytion.access_checker" ]
            - "%eh_encryption.settings%"
            
    # Event subscribers and listeners
    eh_encryption.doctrine_subscriber:
        class: EHEncryptionBundle\EventListener\EncryptionSubscriber
        arguments:
            - "@eh_encryption.encryption.service"
        tags:
            - { name: doctrine.event_subscriber, connection: default, priority: -10 }
    eh_encryption.user_events.subscriber:
        class: EHEncryptionBundle\EventListener\UserEventsSubsbriber
        arguments:
            - "@eh_encryption.encryption.service"
        tags:
            - { name: kernel.event_subscriber }
            
    eh_encryption.user_private_key_load_listener:
        class: EHEncryptionBundle\EventListener\UserPrivateKeyLoadListener
        arguments:
            - "%eh_encryption.settings%"
            - "@security.token_storage"
            - "@eh_encryption.key_manager"
            - "@eh_encryption.key_store"
        tags:
            - { name: kernel.event_listener, event: kernel.response, priority: 2 }
            
    eh_encryption.web_service_private_key_load_listener:
        class: EHEncryptionBundle\EventListener\WebServicePrivateKeyLoadListener
        arguments:
            - "%eh_encryption.settings%"
            - "@security.token_storage"
            - "@eh_encryption.key_manager"
        tags:
            - { name: kernel.event_listener, event: kernel.request }
